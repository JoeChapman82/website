!function(){function e(){t(),i(),Z=!0,H=!1,D=0,we=3,be=1,Le.classList.remove("match-three-inactive-button"),ze.classList.remove("match-three-inactive-button"),N=J}function t(){G=S.getBoundingClientRect(),L=G.width/M,F=G.height/C,ue=(q=~~(M/R))/7.5,j=q/10,H=!1,i()}function n(e){return e*q}function i(){K=[];for(var e=0;e<R;e++){var t=!1;K[e]=[];for(var i=0;i<R;i++){var r=!1;e>1&&K[e-1][i].img===K[e-2][i].img&&(t=K[e-1][i].img),i>1&&K[e][i-1].img===K[e][i-2].img&&(r=K[e][i-1].img);for(var l=a(0,me.length);!1!==r&&l===r||!1!==t&&l===t;)l=a(0,me.length);K[e].push({x:n(e),y:n(i),img:l})}}}function r(){if(Q)m();else{U=!1;for(var e=0;e<K.length;e++){if(K[e].length!==K.length)for(var t=K.length-K[e].length,i=0;i<t;i++)K[e].unshift({x:n(e),y:n(-(i+1)),img:a(0,me.length)});for(var r=0;r<K[e].length;r++)K[e][r].x!==n(e)&&(K[e][r].x+=K[e][r].x>n(e)?-j:j,K[e][r].x=parseFloat(K[e][r].x.toFixed(2)),U=!0),K[e][r].y!==n(r)&&(K[e][r].y+=K[e][r].y>n(r)?-j:j,K[e][r].y=parseFloat(K[e][r].y.toFixed(2)),U=!0)}if(U)H=!1,$=0;else{var l=g(!0);(l=function(e){if(!ve)return e;var t=function(e){{if("colourKiller"===K[O[0].x][O[0].y].specialType&&"colourKiller"===K[O[1].x][O[1].y].specialType)return e=function(){for(var e=[],t=0;t<K.length;t++)for(var n=0;n<K.length;n++)e.push({x:t,y:n});return e}(),{hadSpeciaMove:!0,matches:e};if("colourKiller"===K[O[0].x][O[0].y].specialType)return e.push({x:O[0].x,y:O[0].y}),e=e.concat(h(K[O[1].x][O[1].y].img)),{hadSpeciaMove:!0,matches:e};if("colourKiller"===K[O[1].x][O[1].y].specialType)return e.push({x:O[1].x,y:O[1].y}),e=e.concat(h(K[O[0].x][O[0].y].img)),{hadSpeciaMove:!0,matches:e}}return{hadSpeciaMove:!1}}(e);if(t.hadSpeciaMove)return d(),t.matches;0===e.length&&Se<1?(Se++,O.reverse(),y()):d();return e}(l)).length>0?(U=!0,c(l)):(Y=1,H||(H=u()))}}}function l(e,t,n){T.lineWidth=5,T.strokeStyle=n,T.beginPath(),T.moveTo(e,t),T.lineTo(e+q/5,t),T.moveTo(e,t),T.lineTo(e,t+q/5),T.moveTo(e+q,t),T.lineTo(e+q-q/5,t),T.moveTo(e+q,t),T.lineTo(e+q,t+q/5),T.moveTo(e,t+q),T.lineTo(e,t+q-q/5),T.moveTo(e,t+q),T.lineTo(e+q/5,t+q),T.moveTo(e+q,t+q),T.lineTo(e+q-q/5,t+q),T.moveTo(e+q,t+q),T.lineTo(e+q,t+q-q/5),T.stroke(),T.lineWidth=1}function o(){b.beginPath(),b.fillStyle="rgba(169, 0, 0, 1)",b.textBaseline="middle",b.textAlign="center",b.fillText("Score: "+D,w.width/2,w.height/2)}function a(e,t){return~~(Math.random()*(t-e))+e}function c(e){for(var t=[],i=0;i<e.length;i++)"horizontal"===K[e[i].x][e[i].y].specialType&&t.push(function(e,t){for(var n=[],i=0;i<K.length;i++)K[i][e].img=t,n.push({x:i,y:e});return n}(e[i].y,K[e[i].x][e[i].y].img)),"vertical"===K[e[i].x][e[i].y].specialType&&t.push(function(e,t){for(var n=[],i=0;i<K[e].length;i++)K[e][i].img=t,n.push({x:e,y:i});return n}(e[i].x,K[e[i].x][e[i].y].img));for(var r=0;r<t.length;r++)e=e.concat(t[r]);e.sort(function(e,t){return t.y<e.y?-1:t.y>e.y?1:0});for(var l=[],o=0;o<e.length;o++)0===l.filter(function(t){return t.x===e[o].x&&t.y===e[o].y}).length&&(fe.push({x:n(e[o].x),y:n(e[o].y),colour:ye[K[e[o].x][e[o].y].img],existedFor:0}),e[o].isSpecial?(K[e[o].x][e[o].y].isSpecial=!0,K[e[o].x][e[o].y].specialType=e[o].properties.specialType,void 0!==e[o].properties.specialImg&&(K[e[o].x][e[o].y].specialImg=e[o].properties.specialImg,K[e[o].x][e[o].y].img="x")):K[e[o].x].splice(e[o].y,1),l.push({x:e[o].x,y:e[o].y}));D+=e.length*X*Y}function g(e){xe.length=0;var t=[];return t=t.concat(function(e){for(var t=[],n=0;n<K.length;n++)for(var i=1,r=!1,l=0;l<K[n].length;l++)i=K[n][l].img===r&&"x"!==K[n][l].img?++i:1,r=K[n][l].img,3===i&&t.push({x:n,y:l-2},{x:n,y:l-1},{x:n,y:l}),4===i&&(e&&(t[t.length-2].isSpecial=!0,t[t.length-2].properties={specialType:"horizontal"}),t.push({x:n,y:l})),5===i&&(e&&(delete t[t.length-3].isSpecial,delete t[t.length-3].properties,t[t.length-2].isSpecial=!0,t[t.length-2].properties={specialType:"colourKiller",specialImg:0}),t.push({x:n,y:l}));return t}(e)),t=t.concat(function(e){for(var t=[],n=0;n<K.length;n++)for(var i=1,r=!1,l=0;l<K.length;l++)i=K[l][n].img===r&&"x"!==K[n][l].img?++i:1,r=K[l][n].img,3===i&&t.push({x:l-2,y:n},{x:l-1,y:n},{x:l,y:n}),4===i&&(e&&(t[t.length-2].isSpecial=!0,t[t.length-2].properties={specialType:"vertical"}),t.push({x:l,y:n})),5===i&&(e&&(delete t[t.length-3].isSpecial,delete t[t.length-3].properties,t[t.length-2].isSpecial=!0,t[t.length-2].properties={specialType:"colourKiller",specialImg:0}),t.push({x:l,y:n}));return t}(e))}function h(e){for(var t=[],n=0;n<K.length;n++)for(var i=0;i<K.length;i++)K[n][i].img===e&&t.push({x:n,y:i});return t}function s(){for(var e=[],t=0;t<K.length;t++)for(var n=0;n<K[t].length;n++)K[t][n].isSpecial&&e.push({x:t,y:n});return e}function u(){for(var e=!1,t=0,n=a(0,K.length);t<K.length;n=(n+1)%K.length){t++;for(var i=0;i<K.length;i++){if("colourKiller"===K[n][i].specialType)return{x:n,y:i,direction:n<K.left?"right":"left"};for(var r=K[n][i],l=[{x:n-1,y:i,condition:0!==n,direction:"left"},{x:n+1,y:i,condition:n!==K.length-1,direction:"right"},{x:n,y:i-1,condition:0!==i,direction:"up"},{x:n,y:i+1,condition:i!==K.length-1,direction:"down"}],o=0;o<4;o++)if(l[o].condition&&!e&&(K[n][i]=K[l[o].x][l[o].y],K[l[o].x][l[o].y]=r,matches=g(!1),e=matches.length>0&&K[matches[0].x][matches[0].y].img===r.img&&K[matches[1].x][matches[1].y].img===r.img&&K[matches[2].x][matches[2].y].img===r.img,K[l[o].x][l[o].y]=K[n][i],K[n][i]=r,e))return{x:n,y:i,direction:l[o].direction}}}if(!e)return m(),!1}function m(){Q=!0,Te=!0;for(var e=!0,t=M/2-n(.5),i=C/2-n(.5),r=0;r<K.length;r++)for(var l=0;l<K.length;l++)(K[r][l].x>t+j||K[r][l].x<t-j)&&(K[r][l].x+=K[r][l].x>t?-j:j,K[r][l].x=parseFloat(K[r][l].x.toFixed(2)),e=!1),(K[r][l].y>i+j||K[r][l].y<i-j)&&(K[r][l].y+=K[r][l].y>i?-j:j,K[r][l].y=parseFloat(K[r][l].y.toFixed(2)),e=!1);e&&(K.forEach(function(e){e.forEach(function(e){e.img=a(0,me.length)})}),P=!0,setTimeout(function(){Te=!1,P=!1,Q=!1,z=requestAnimationFrame(v)},500))}function d(){O.length=0,ve=!1,Se=0}function y(){var e=[K[O[0].x][O[0].y],K[O[1].x][O[1].y]];Math.abs(O[0].x-O[1].x)+Math.abs(O[0].y-O[1].y)<=1?(K[O[0].x][O[0].y]=e[1],K[O[1].x][O[1].y]=e[0],ve=!0):O.shift()}function f(){document.getElementById(this.dataset.hide).classList.add("js-hidden"),document.getElementById(this.dataset.show).classList.remove("js-hidden"),"gameScreen"===(Ee=this.dataset.screen)&&e()}function p(){k.clearRect(0,0,E.width,E.height),k.beginPath(),k.moveTo(0,E.height),k.lineTo(E.width,E.height),k.stroke(),k.beginPath(),k.moveTo(0,0),k.lineTo(E.width,0),k.stroke(),k.beginPath(),k.fillText("GAME OVER",E.width/2,50),k.fillText("Score: "+D,E.width/2,150),k.fill(),o()}function x(){$+=A,(N-=A)<0&&(Z=!1,N=0,U||(0===s().length?V?e():(Ee="gameOverScreen",document.getElementById("gameScreen").classList.add("js-hidden"),document.getElementById("matchThreeGameOverScreen").classList.remove("js-hidden")):c(s()))),T.clearRect(0,0,M,C),b.clearRect(0,0,w.width,w.height),B.clearRect(0,0,I.width,I.height),V&&(te+=A)>=ne&&H&&(te=0,1===O.length?(O[0]={x:H.x,y:H.y},O[1]={x:"left"===H.direction?H.x-1:"right"===H.direction?H.x+1:H.x,y:"up"===H.direction?H.y-1:"down"===H.direction?H.y+1:H.y},y()):O[0]={x:H.x,y:H.y}),r(),function(){for(var e=fe.length-1;e>=0;e--)fe[e].existedFor+=A,fe[e].existedFor>=pe&&fe.splice(e,1)}(),function(){for(var e=["rgba(128, 128, 128, 0.95)","rgba(169, 169, 169, 0.95)"],t=0;t<K.length;t++)for(var i=0;i<K.length;i++)T.fillStyle=i+t&1?e[1]:e[0],T.fillRect(n(t),n(i),q,q)}(),function(){for(var e=0;e<fe.length;e++)T.beginPath(),T.fillStyle=fe[e].colour,T.rect(fe[e].x,fe[e].y,q,q),T.fill()}(),function(){T.strokeStyle="black",T.textAlign="center",T.lineWidth=5,T.textBaseline="middle";for(var e=0;e<K.length;e++)for(var t=0;t<K[e].length;t++){T.beginPath(),!1!==H&&H.x===e&&H.y===t&&$>ee&&l(K[e][t].x,K[e][t].y,"red"),1===O.length&&O[0].x===e&&O[0].y===t&&l(K[e][t].x,K[e][t].y,"yellow");var n;n=K[e][t].isSpecial?void 0!==K[e][t].specialImg?de[K[e][t].specialImg]:"vertical"===K[e][t].specialType?me[K[e][t].img].vertical:me[K[e][t].img].horizontal:me[K[e][t].img].normal,T.drawImage(n,K[e][t].x+ue,K[e][t].y+ue,q-2*ue,q-2*ue),T.fill(),T.stroke()}}(),o(),function(){b.lineWidth=8,B.lineWidth=8;var e=N>5?60:Math.abs(60*(N-Math.floor(N)-.5)/.5);b.strokeStyle="hsl("+e+", 100%, 50%)",B.strokeStyle="hsl("+e+", 100%, 50%)",b.beginPath(),b.moveTo(0,w.height),b.lineTo(w.width,w.height),b.stroke(),B.beginPath(),B.moveTo(0,0),B.lineTo(I.width,0),B.stroke()}(),Te&&(T.beginPath(),T.font="Bold 42px Arial Black",T.fillStyle="black",T.textAlign="center",T.textBaseline="hanging",T.fillText("Shuffling pieces",M/2,50),T.fill()),function(){var e=N/J*120,t=(I.width-20)*(N/J);B.fillStyle="rgba(188, 188, 188, 0.6)",B.beginPath(),B.rect(10,I.height-50,I.width-20,30),B.fill(),B.fillStyle="hsl("+e+", 100%, 50%)",B.beginPath(),B.rect(10,I.height-50,t,30),B.fill(),B.beginPath(),B.textAlign="center",B.textBaseline="bottom",B.fillText("Time: "+N.toFixed(),I.width/2,I.height-50)}()}function v(e){!function(e){A=e-_<250?(e-_)/1e3:.0167,_=e}(e),Be[Ee](),P||(z=requestAnimationFrame(v))}var S=document.getElementById("matchThreeCanvasMiddle"),T=S.getContext("2d"),w=document.getElementById("matchThreeCanvasTop"),b=w.getContext("2d"),I=document.getElementById("matchThreeCanvasBottom"),B=I.getContext("2d"),E=document.getElementById("matchThreeGameOverCanvas"),k=E.getContext("2d");b.font="Bold 42px Arial Black",B.font="Bold 42px Arial Black",k.font="Bold 72px Arial Black",k.lineWidth=8,k.strokeStyle="hsl(0, 100%, 50%)",k.fillStyle="hsl(0, 100%, 50%)",k.textAlign="center",k.textBaseline="hanging";var z,L,F,_=0,A=0,P=!1,M=S.width,C=S.height,R=8,q=0,K=[],W=!1,G=0,O=[],j=0,D=0,X=50,Y=1,V=!1,H=!1,J=60,N=0,Q=!1,U=!1,Z=!1,$=0,ee=5,te=0,ne=1,ie={normal:new Image,horizontal:new Image,vertical:new Image},re={normal:new Image,horizontal:new Image,vertical:new Image},le={normal:new Image,horizontal:new Image,vertical:new Image},oe={normal:new Image,horizontal:new Image,vertical:new Image},ae={normal:new Image,horizontal:new Image,vertical:new Image},ce={normal:new Image,horizontal:new Image,vertical:new Image},ge=new Image,he=new Image,se="/images/games/puzzle/match-three/",ue=0;ie.normal.src=se+"blue-gems/blue_01.png",ie.horizontal.src=se+"blue-gems/blue_horizontal.png",ie.vertical.src=se+"blue-gems/blue_vertical.png",re.normal.src=se+"green-gems/green_02.png",re.horizontal.src=se+"green-gems/green_horizontal.png",re.vertical.src=se+"green-gems/green_vertical.png",le.normal.src=se+"pink-gems/pink_03.png",le.horizontal.src=se+"pink-gems/pink_horizontal.png",le.vertical.src=se+"pink-gems/pink_vertical.png",oe.normal.src=se+"purple-gems/purple_04.png",oe.horizontal.src=se+"purple-gems/purple_horizontal.png",oe.vertical.src=se+"purple-gems/purple_vertical.png",ae.normal.src=se+"red-gems/red_05.png",ae.horizontal.src=se+"red-gems/red_horizontal.png",ae.vertical.src=se+"red-gems/red_vertical.png",ce.normal.src=se+"yellow-gems/yellow_06.png",ce.horizontal.src=se+"yellow-gems/yellow_horizontal.png",ce.vertical.src=se+"yellow-gems/yellow_vertical.png",ge.src=se+"multicolor-gems/mc_03.png",he.src=se+"bg.png";var me=[ie,re,le,oe,ae,ce],de=[ge],ye=["rgba(150, 150, 255, 0.4)","rgba(0, 255, 0, 0.4)","rgba(255, 192, 203, 0.6)","rgba(128, 0, 128, 0.4)","rgba(255, 0, 0, 0.4)","rgba(255, 255, 0, 0.4)"],fe=[],pe=.8,xe=[],ve=!1,Se=0,Te=!1,we=3,be=1,Ie=[],Be={titleScreen:function(){return T.fillStyle="rgba(222, 222, 222, 0.1)",void T.fillRect(0,0,M,C)},loadingScreen:function(){return loadingScreen()},gameScreen:function(){return x()},settingsScreen:function(){return settingsScreen()},howToScreen:function(){return howToScreen()},pauseScreen:function(){return pauseScreen()},gameOverScreen:function(){return p()}},Ee="titleScreen",ke=document.getElementById("matchThreePauseButton"),ze=document.getElementById("matchThreeExplodeButton"),Le=document.getElementById("matchThreeShuffleButton"),Fe=document.getElementById("startGameButton");e(),z=requestAnimationFrame(v),window.addEventListener("resize",t),S.addEventListener("mousedown",function(e){if(Z){W=!0;var t=~~((e.x-G.x)/(q*L)),n=~~((e.y-G.y)/(q*F));return O.push({x:t,y:n}),2===O.length&&y()}}),S.addEventListener("mouseup",function(e){if(!ve)return W=!1,2===O.length&&y()}),S.addEventListener("mousemove",function(e){if(W&&!(O.length<1)){var t=~~((e.x-G.x)/(q*L)),n=~~((e.y-G.y)/(q*F));t!==O[0].x||n!==O[0].y?(O[1]={x:t,y:n},y(),W=!1):O.length=1}}),S.addEventListener("mouseout",d),S.addEventListener("touchstart",function(e){if("gameScreen"===Ee){e.preventDefault(),W=!0;var t=~~((e.touches[0].clientX-G.x)/(q*L)),n=~~((e.touches[0].clientY-G.y)/(q*F));return O.push({x:t,y:n}),2===O.length&&y()}},!0),S.addEventListener("touchmove",function(e){if("gameScreen"===Ee&&(e.preventDefault(),W&&!(O.length<1))){var t=~~((e.touches[0].clientX-G.x)/(q*L)),n=~~((e.touches[0].clientY-G.y)/(q*F));t!==O[0].x||n!==O[0].y?(O[1]={x:t,y:n},y(),W=!1):O.length=1}},!0),S.addEventListener("touchend",function(e){if("gameScreen"===Ee&&(e.preventDefault(),!ve))return W=!1,2===O.length&&y()},!0),document.addEventListener("keydown",function(e){"titleScreen"===Ee&&(Ie.push(e.keyCode),Ie.length=Ie.length>4?4:Ie.length,4===Ie.length&&68===Ie[0]&&69===Ie[1]&&77===Ie[2]&&79===Ie[3]&&(V=!0,document.getElementById("startGameButton").style.backgroundColor="red"))}),document.querySelectorAll(".change-screen-button").forEach(function(e){e.addEventListener("click",f)}),ke.addEventListener("click",function(){z=(P=!P)?z:requestAnimationFrame(v)}),ze.addEventListener("click",function(){Z&&be>0&&(0==--be&&ze.classList.add("match-three-inactive-button"),c(s()))}),Le.addEventListener("click",function(){Z&&we>0&&!Q&&(0==--we&&Le.classList.add("match-three-inactive-button"),m())}),Fe.addEventListener("click",function(){var e=document.getElementById("fullScreenWrapper"),t=e.requestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen;try{t.call(e)}catch(e){console.log("no full screen")}})}();